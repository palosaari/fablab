
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.4.0">
    
    
      
        <title>Final Project - Fab Lab Oulu Student Blog</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.69437709.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#final-project" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Fab Lab Oulu Student Blog" class="md-header__button md-logo" aria-label="Fab Lab Oulu Student Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Fab Lab Oulu Student Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Final Project
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Fab Lab Oulu Student Blog" class="md-nav__button md-logo" aria-label="Fab Lab Oulu Student Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Fab Lab Oulu Student Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        About Me
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Final Project
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Final Project
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#weather-station" class="md-nav__link">
    Weather station
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#microcontroller-board-electronic-design" class="md-nav__link">
    Microcontroller board electronic design
  </a>
  
    <nav class="md-nav" aria-label="Microcontroller board electronic design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#main-design-principles" class="md-nav__link">
    Main design principles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mcu-power-supply" class="md-nav__link">
    MCU power supply
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crystals" class="md-nav__link">
    Crystals
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#programming-interfaces" class="md-nav__link">
    Programming interfaces
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spi-i2c-uart-ports" class="md-nav__link">
    SPI / I2C / UART ports
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ultrasonic-sensing-interface" class="md-nav__link">
    Ultrasonic sensing interface
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#microcontroller-board-pcb" class="md-nav__link">
    Microcontroller board PCB
  </a>
  
    <nav class="md-nav" aria-label="Microcontroller board PCB">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pcb-design" class="md-nav__link">
    PCB design
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pcb-manufacturing" class="md-nav__link">
    PCB manufacturing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#soldering-components" class="md-nav__link">
    Soldering components
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#temperature-sensor" class="md-nav__link">
    Temperature sensor
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bluetooth-radio" class="md-nav__link">
    Bluetooth radio
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#software-development" class="md-nav__link">
    Software development
  </a>
  
    <nav class="md-nav" aria-label="Software development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toolchain" class="md-nav__link">
    Toolchain
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mcu-software" class="md-nav__link">
    MCU software
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#home-assistant-bluetooth-integration" class="md-nav__link">
    Home Assistant Bluetooth integration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#case-design" class="md-nav__link">
    Case design
  </a>
  
    <nav class="md-nav" aria-label="Case design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#making-the-device-case" class="md-nav__link">
    Making the device case
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#radiation-shield-section" class="md-nav__link">
    Radiation shield section
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wind-tunnel-section" class="md-nav__link">
    Wind tunnel section
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#microcontroller-housing-section" class="md-nav__link">
    Microcontroller housing section
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modeling-of-the-device-housing" class="md-nav__link">
    Modeling of the device housing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-the-case" class="md-nav__link">
    Making the case
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-a-sticker" class="md-nav__link">
    Making a sticker
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bill-of-material" class="md-nav__link">
    Bill of material
  </a>
  
    <nav class="md-nav" aria-label="Bill of material">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#main-pcb" class="md-nav__link">
    Main PCB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bluetooth-radio_1" class="md-nav__link">
    Bluetooth radio
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#temperature-sensor_1" class="md-nav__link">
    Temperature sensor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#case" class="md-nav__link">
    Case
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#licenses" class="md-nav__link">
    Licenses
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#files" class="md-nav__link">
    Files
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#final-thoughts" class="md-nav__link">
    Final thoughts
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Assignments
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Assignments" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week01/" class="md-nav__link">
        1. Principles and practices
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week02/" class="md-nav__link">
        2. Project management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week03/" class="md-nav__link">
        3. Computer-Aided Design
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week04/" class="md-nav__link">
        4. Computer controlled cutting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week05/" class="md-nav__link">
        5. Invention, intellectual property and income
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week06/" class="md-nav__link">
        6. Electronics production
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week07/" class="md-nav__link">
        7. Electronics design
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week08/" class="md-nav__link">
        8. Input devices
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week09/" class="md-nav__link">
        9. Output devices
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week10/" class="md-nav__link">
        10. Embedded programming
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week11/" class="md-nav__link">
        11. Interface and application programming
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week12/" class="md-nav__link">
        12. Applications and implications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week13/" class="md-nav__link">
        13. Networking and communications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week14/" class="md-nav__link">
        14. 3D Scanning and Printing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week15/" class="md-nav__link">
        15. Molding and Casting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week16/" class="md-nav__link">
        16. Computer Controlled Machining
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week18/" class="md-nav__link">
        18 A. Mechanical Design (part 1 of 2)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week18_groupwork/" class="md-nav__link">
        18 B. Mechanical Design (part 1 of 2) - group project
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week19/" class="md-nav__link">
        19 A. Machine Design (part 2 of 2)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assignments/week19_groupwork/" class="md-nav__link">
        19 B. Machine Design (part 2 of 2) - group project
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#weather-station" class="md-nav__link">
    Weather station
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#microcontroller-board-electronic-design" class="md-nav__link">
    Microcontroller board electronic design
  </a>
  
    <nav class="md-nav" aria-label="Microcontroller board electronic design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#main-design-principles" class="md-nav__link">
    Main design principles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mcu-power-supply" class="md-nav__link">
    MCU power supply
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crystals" class="md-nav__link">
    Crystals
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#programming-interfaces" class="md-nav__link">
    Programming interfaces
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spi-i2c-uart-ports" class="md-nav__link">
    SPI / I2C / UART ports
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ultrasonic-sensing-interface" class="md-nav__link">
    Ultrasonic sensing interface
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#microcontroller-board-pcb" class="md-nav__link">
    Microcontroller board PCB
  </a>
  
    <nav class="md-nav" aria-label="Microcontroller board PCB">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pcb-design" class="md-nav__link">
    PCB design
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pcb-manufacturing" class="md-nav__link">
    PCB manufacturing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#soldering-components" class="md-nav__link">
    Soldering components
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#temperature-sensor" class="md-nav__link">
    Temperature sensor
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bluetooth-radio" class="md-nav__link">
    Bluetooth radio
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#software-development" class="md-nav__link">
    Software development
  </a>
  
    <nav class="md-nav" aria-label="Software development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toolchain" class="md-nav__link">
    Toolchain
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mcu-software" class="md-nav__link">
    MCU software
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#home-assistant-bluetooth-integration" class="md-nav__link">
    Home Assistant Bluetooth integration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#case-design" class="md-nav__link">
    Case design
  </a>
  
    <nav class="md-nav" aria-label="Case design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#making-the-device-case" class="md-nav__link">
    Making the device case
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#radiation-shield-section" class="md-nav__link">
    Radiation shield section
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wind-tunnel-section" class="md-nav__link">
    Wind tunnel section
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#microcontroller-housing-section" class="md-nav__link">
    Microcontroller housing section
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modeling-of-the-device-housing" class="md-nav__link">
    Modeling of the device housing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-the-case" class="md-nav__link">
    Making the case
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-a-sticker" class="md-nav__link">
    Making a sticker
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bill-of-material" class="md-nav__link">
    Bill of material
  </a>
  
    <nav class="md-nav" aria-label="Bill of material">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#main-pcb" class="md-nav__link">
    Main PCB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bluetooth-radio_1" class="md-nav__link">
    Bluetooth radio
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#temperature-sensor_1" class="md-nav__link">
    Temperature sensor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#case" class="md-nav__link">
    Case
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#licenses" class="md-nav__link">
    Licenses
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#files" class="md-nav__link">
    Files
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#final-thoughts" class="md-nav__link">
    Final thoughts
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="final-project">Final Project</h1>
<h2 id="weather-station">Weather station</h2>
<p><img alt="" src="../images/finalproject/presentation.png" /></p>
<p><div class="video-container"><iframe src="../images/finalproject/presentation.mp4" style="position: relative; width: 100%; height: 22.172vw" frameborder="0" allowfullscreen></iframe></div></p>
<p>I am interested in monitoring the state of the environment and I already have several temperature, humidity and air pressure sensors that are connected to the Home Assistant home automation system. Collecting data centrally to home automation system opens up many possibilities in terms of sensor data use. For example, the system stores historical data, the automation can control the car's engine heater based on the outdoor temperature and offers multiple user interfaces, www-interface, mobile app, etc... </p>
<p>The sensors I use outdoors are mainly connected to the automation via theEspressif Systems ESP8266-based module WiFi using the MQTT protocol. For ESP8266 firmware I use <a href="https://tasmota.github.io/docs/">Tasmota</a>. I have used several sensors from different manufacturers, e.g. Bosch Sensortec BME280, NXP LM75A, Silicon Laboratories Si7021 and Sensirion SHT31. BME280 is my favorite sensor because it has 3 sensors in the same package, temperature, humidity and air pressure. In addition my Home Assistant has some commercial weather station sensors that transmit data on the 433MHz ISM band. </p>
<p>The sensors I use indoors are the Aqara Temperature and Humidity Sensor (WSDCGQ11LM) which connects via the ZigBee protocol and the Xiaomi Mi Home Bluetooth Thermometer 2 (LYWSD03MMC) which connects via Bluetooth. </p>
<p>However, I'm missing an anemometer. I have considered buying some commercial anemometers based on ultrasonic technology, but they are not very common yet and are quite expensive. The Finnish winter is quite harsh and places special demands on the device. The device should be able to withstand -50C frost, because the coldest temperatures in the area have been a little over -50C, and -40C is not uncommon. In commercial devices, the coldest operating temperature is usually -40C or even worse. For example, the Auriol AHFL 433 B2 outdoor temperature sensor bought from Lidl freezes (reset loop) at temperatures slightly above -20C, which is far too low in the Finnish climate. </p>
<p>In the end, I ended up designing my own anemometer, even though it doesn't seem very realistic due to the complexity of things. When researching microcontroller options, I ended up with the Texas Instruments MSP430FR6043 MCU, which seemed like the most reasonable package. This chip has an integrated microcontroller and an ultrasound frontend that is made for gas flow measurement. The ultrasound wave is digitized with an ADC converter and all calculations are done digitally by the microcontroller. However, due to the lack of time, I had to limit my work so that I left out the most interesting part, the ultrasound measurement, and focused on making the basic features work somehow. </p>
<p>Here are some ultrasonic anemometer solutions I found that are somehow similar I am designing. Some of those seems to use MCU from STMicroelectronics. I did not find any anemometer build on MSP430FR6043 (or same family), the MCU I am using, but sure in the real life there must be at least some commercial ones. </p>
<ul>
<li>Commercial <ul>
<li><a href="https://weatherflow.com/tempest-weather-system/">Tempest Weather Station</a></li>
<li><a href="https://www.ecowitt.com">Ecowitt</a></li>
<li><a href="https://www.netatmo.com/en-gb/weather/weatherstation/anemometer">Netatmo</a></li>
</ul>
</li>
<li>DIY <ul>
<li><a href="https://github.com/majianjia/QingStation">QingStation</a></li>
</ul>
</li>
</ul>
<h2 id="microcontroller-board-electronic-design">Microcontroller board electronic design</h2>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/wiima_kicad_schematic_main.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>KiCAD main schematic</td>
</tr>
</tbody>
</table>
<p>I chose <a href="https://www.ti.com/product/MSP430FR6043">Texas Instruments MSP430FR6043</a> as the microcontroller. The selection of the microcontroller was mainly influenced by the integrated digital ultrasonic frontend suitable for measuring gas flows. Another important reason was the extremely low power consumption, since the weather station often relies on battery-powered power supply. I had absolutely no previous experience with MSP430 family microcontrollers, which made designing the device very difficult. </p>
<p>The microcontroller, the exact model MSP430FR6043IPN, was packed in an 80-pin LQFP case with a physical size of only 12mm x 12mm. There was no symbol for the component in KiCAD, so I downloaded a suitable one from the <a href="https://componentsearchengine.com/">Electronic Component Search Engine</a> provided by SamacSys. The license is:</p>
<pre><code>1. There are no restrictions on the circuit board designs you make with our library components.
2. You do not need to credit SamacSys in any way after using our Libraries.
3. You will not distribute our models in any form usable as a PCB Library Component - except within your own company.
</code></pre>
<p>I interpret that point 3 of the license prohibits the distribution of the downloaded component together with the KiCAD project, so I do not distribute the KiCAD project. The matter needs to be clarified later and perhaps change the model of the component to another or define your own model. </p>
<p>In the end, I managed to define my own MSP430FR6043IPN KiCAD symbol to get rid of the SamacSys license. It wasn't difficult, but it was quite time consuming as there was 80 pins on the chip. There was no need to define a footprint because KiCAD already had a suitable one. </p>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/wiima_kicad_symbol.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>MSP430FR6043IPN symbol I defined</td>
</tr>
</tbody>
</table>
<ul>
<li><a href="https://www.ti.com/product/MSP430FR6043">Texas Instruments MSP430FR6043</a></li>
</ul>
<h3 id="main-design-principles">Main design principles</h3>
<p>I designed the circuit around the MSP430FR6043 MCU using the following main points:</p>
<ul>
<li>No ultrasonic measurement. The ultrasonic measurement related pins on the microcontroller are routed to the connector for later development.</li>
<li>No power supply, will add it later</li>
<li>All possible I2C/SPI/UART buses are routed to connectors for connecting additional devices</li>
<li>Programming interface Spy-Bi-Wire (serial JTAG)</li>
<li>HID Bridge I2C interface for Ultrasonic Sensing Design Center application. That interface allows GUI application to communicate towards MCU and adjust various Ultrasonic specific configuration values.</li>
</ul>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/wiima_kicad_schematic_mcu.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h3 id="mcu-power-supply">MCU power supply</h3>
<p>I installed filtering capacitors and resistors on all power supplies of the MCU according to the datasheet. The MCU had several completely separate power supplies, analog, digital and ultrasonic, which had to be separated from each other so that interference could not pass from one block of the circuit to another. However, I did not implement them, so there are probably losses in the sensitivity of the analog side. </p>
<h3 id="crystals">Crystals</h3>
<p>Multiple clock sources can be used quite freely in the MCU. There are at least 3 external clock inputs, low frequency, high frequency and ultrasonic. I'm not even sure I need them all. However, I installed 2 crystals, low frequency crystal 32.768kHz and high frequency 8 MHz. I bought the crystals from a local electronics store and there were no datasheets for them, so I couldn't calculate the correct bypass capacitor values. I installed about 20pF capacitors. The crystals should be isolated in their own islands to avoid interference, but I didn't do that either.</p>
<h3 id="programming-interfaces">Programming interfaces</h3>
<p>As the programming connector, I chose a 20-pin connector that corresponds to the <a href="https://software-dl.ti.com/msp430/msp430_public_sw/mcu/msp430/CapTIvate_Design_Center/latest/exports/docs/users_guide/html/CapTIvate_Technology_Guide_html/markdown/ch_evm_CAPT_PGMR.html">Texas Instruments CAPTIVATE-PGMR</a> programmer connector. I routed the Spy-Bi-Wire, HID-bridge I2C and HID-bridge UART lines to the connector. Such a big connector was a mistake and the next version will probably only have 2 pins for Spy-Bi-Wire (serial JTAG).</p>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/wiima_kicad_schematic_debug.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Debug connectors</td>
</tr>
</tbody>
</table>
<h3 id="spi-i2c-uart-ports">SPI / I2C / UART ports</h3>
<p>The MCU has 6 ports that I routed all to connectors for connecting additional devices. The ports have some limitations, e.g. I2C was only available on UCB0 and UCB1 ports, so I enabled both of them as I2C. I divided the remaining ports equally between SPI and UART. I installed 10k ohm pull-up resistors on the I2C enabled ports. </p>
<table>
<thead>
<tr>
<th>eUSCI</th>
<th>mode</th>
</tr>
</thead>
<tbody>
<tr>
<td>UCA0</td>
<td>SPI</td>
</tr>
<tr>
<td>UCA1</td>
<td>UART</td>
</tr>
<tr>
<td>UCA2</td>
<td>SPI</td>
</tr>
<tr>
<td>UCA3</td>
<td>UART</td>
</tr>
<tr>
<td>UCB0</td>
<td>I2C</td>
</tr>
<tr>
<td>UCB1</td>
<td>I2C</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/wiima_kicad_schematic_i2c.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>I2C port KiCAD schematic</td>
</tr>
</tbody>
</table>
<h3 id="ultrasonic-sensing-interface">Ultrasonic sensing interface</h3>
<p>I routed the pins related to the ultrasonic measurement to their own connector for later use. </p>
<h2 id="microcontroller-board-pcb">Microcontroller board PCB</h2>
<h3 id="pcb-design">PCB design</h3>
<p>The physical size and shape of the device had to be taken into account when designing the circuit board. I tried to make the PCB as small as possible and slightly round in appearance.</p>
<p>I should also have taken into account the interference transfer between the circuit's analog and digital blocks and crystals, but I didn't.</p>
<p>I used a single-sided PCB, which was really difficult and a lot of work to design such a large schematic with KiCAD. I had to put in some 0 ohm jumper resistors because the wiring got crossed. Next time I will make a 2-sided PCB. </p>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/wiima_kicad_pcb.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>PCB KiCAD model</td>
</tr>
</tbody>
</table>
<h3 id="pcb-manufacturing">PCB manufacturing</h3>
<p>I made the PCB with the LPKF ProtoMat S62 milling machine, which I had already made some PCBs with in previous exercises.</p>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/mcu_pcb.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>PCB milled</td>
</tr>
</tbody>
</table>
<h3 id="soldering-components">Soldering components</h3>
<p>I installed the 80-pin MCU using solder paste and baking in the oven. It didn't work out perfectly because the paste went too much in some places and caused short circuits. Some of the short circuits were in a difficult place behind the MCU pins, which were really difficult to fix by hand. I soldered the pins off, turned to the side and cut the foil that was short-circuited on the back side. I soldered the rest of the components by hand.</p>
<p>FabLab does not have a proper digital soldering microscope, which would be a great help when working with such small components. </p>
<p>Not all component sizes could be found in FabLab, so I replaced them with the closest value. </p>
<p>All in all, there were quite a few components on the circuit board. </p>
<p>However, the circuit board worked right away and I didn't have to make a new one or make any changes to the original one. </p>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/mcu_pcb_paste.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Poor paste mask</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/mcu_pcb_mcu.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Attach MCU to paste</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/mcu_pcb_oven.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Baked PCB / MCU</td>
</tr>
</tbody>
</table>
<h2 id="temperature-sensor">Temperature sensor</h2>
<p>I thought I would use the <a href="https://www.bosch-sensortec.com/products/environmental-sensors/humidity-sensors-bme280/">Bosch Sensortec BME280</a> 3-in-1, temperature, humidity and air pressure sensor. However, controlling the sensor seemed so complicated that it would have required a library and the schedule was tight, so I looked into other sensors that I happened to have. The register map of the <a href="https://www.nxp.com/part/LM75AD#/">NXP LM75AD</a> temperature sensor looked very simple, you could read the temperature from it in the default mode with 9 bits with a resolution of 0.5 degrees. If you only read one byte, you got 8 uppermost bits, so the resolution drops from 0.5 degrees to one degree. That was enough for me for this exercise and I left out the least significant bit. </p>
<p>The sensor I used was mounted on a ready-made circuit board of the "CJMCU-75" model. I soldered the jumpers on the board for I2C Address selection and soldered the pin header for the connections. I tried reading the sensor on the EVM430-FR6043 board with a small test program, but it didn't work despite several attempts. I have previously used these sensors with Tasmota firmware with the Wemos D1 mini Board, so I decided to try it again to see if they work. The sensor worked and I could read the temperature from the sensor. I tried to use a logic analyzer to see what kind of data is moving between the device and the sensor. However, there were problems here - every time the switch between the sensor of the logic analyzer and the microcontroller, the connection was lost. I concluded that the pull-up of the I2C bus is too weak and the extra load from the logic analyzer causes the bus to either go to zero or at least float randomly. I measured the CJMCU-75 board had 10k ohm pull-up resistors, which are perhaps a bit weak when around 5k are usually used. I soldered the extra 10k pull-up resistors directly to the I2C SDA and SCL legs of the board in order to boost the bus pull-up to 5k ohms. After that, the connection worked with the logic analyzer. With the logic analyzer I saw that I had used the wrong I2C address. In the end, I was able to read the temperature from the circuit with the EVM430-FR6043 development board and with my own designed board. </p>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/logic_i2c.resized.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Logic analyzer, I2C</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/lm75_board_bottom.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Extra pull-ups soldered</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/lm75_board_top.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><a href="https://www.nxp.com/part/LM75AD#/">NXP LM75AD</a></li>
<li><a href="https://www.bosch-sensortec.com/products/environmental-sensors/humidity-sensors-bme280/">Bosch Sensortec BME280</a></li>
</ul>
<h2 id="bluetooth-radio">Bluetooth radio</h2>
<p>My goal is to send data from the weather station to home automation. The distance between the outdoor weather station and home automation is usually tens of meters, so the characteristics of the link radio become significant in the design criteria. Longer link intervals can be obtained with traditional 433MHz license-free radios and digital LoRa radio technology. Radio technologies suitable for shorter distances include e.g. ZigBee and Bluetooth. </p>
<p>The Home Assistant automation system I use recently got native support for Bluetooth sensors, which gave one easy option for communication. FabLab had several different Bluetooth modules, so I ended up trying one that was <a href="https://www.microchip.com/en-us/product/RN4871#">Microchip Technology RN4871</a>. The module was interesting in that it had a UART as a control bus and commands could be given from the terminal, so I could relatively easily test completely new technology for myself. </p>
<p>I made a simple circuit board according to the datasheet with the connection of the operating current and the UART. I tested the device I made by entering commands over the UART and looked at the data sent by the module with the <a href="https://play.google.com/store/apps/details?id=com.macdom.ble.blescanner">BLE Scanner (Connect &amp; Notify)</a> Android application. I already had a few indoor air condition meters that sent data to home automation according to the <a href="https://bthome.io/">BTHome</a> protocol, so I studied the data they sent with the BLE Scanner (Connect &amp; Notify) application and tried to get the RN4871 to send similar data. After researching and testing possible commands from the RN4871 module user's guide, I found the right 'IA' (advertisement) command to send a suitable data packet. After the correct packet was sent, Home Assistant Bluetooth autodiscovery found the new sensor and displayed the temperature. </p>
<p>According to the protocol example on the BTHome website, the 25C temperature data is encoded as 0x1C18 2302C409. This same information can be sent with the RN4871 module by issuing the command: IA,16,1C182302C409 </p>
<ul>
<li><a href="https://www.microchip.com/en-us/product/RN4871#">Microchip Technology RN4871</a></li>
<li><a href="https://bthome.io/">BTHome</a></li>
<li><a href="https://play.google.com/store/apps/details?id=com.macdom.ble.blescanner">BLE Scanner (Connect &amp; Notify)</a></li>
</ul>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/RN4871_schematic.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>RN4871 KiCAD schematic</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/RN4871_pcb.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>RN4871 KiCAD PCB</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/RN4871_3d.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>RN4871 KiCAD 3D model</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/bt_board_top.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/bt_board_bottom.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/bt_uart_test.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Testing Bluetooth module using EVM USB-UART</td>
</tr>
</tbody>
</table>
<h2 id="software-development">Software development</h2>
<h3 id="toolchain">Toolchain</h3>
<p>I used <a href="https://www.ti.com/tool/CCSTUDIO">Texas Instruments CCSTUDIO</a>, Code Composer Studio, IDE for software development. It is a full-fledged development environment, including all the normal tools and a JTAG debugger as well. </p>
<ul>
<li><a href="https://www.ti.com/tool/CCSTUDIO">Texas Instruments CCSTUDIO</a></li>
</ul>
<h2 id="mcu-software">MCU software</h2>
<p>I made a really simple program for the microcontroller that practically just reads the temperature sensor and sends the temperature data via Bluetooth in a loop. The temperature sensor is read on the I2C bus and the Bluetooth radio is on the UART bus. The program is made really stupidly and against all good habits by reading and writing UART and I2C port registers directly without using interrupts. I didn't use any specific libraries. </p>
<pre><code class="language-c">#include &lt;msp430.h&gt;
#include &lt;stdint.h&gt;
#include &lt;stdio.h&gt;

int main(void)
{
    char uart_buf[40];
    int i, uart_buf_n;
    uint16_t temperature;

    WDTCTL = WDTPW | WDTHOLD;
    PM5CTL0 &amp;= ~LOCKLPM5;

    // UART UCA3 9600
    // P2.0 UCA1TXD, P2.1 UCA1RXD (RX not used)
    UCA3CTLW0 |= UCSWRST;
    UCA3CTLW0 |= UCSSEL__SMCLK;     // clock source SMCLK
    UCA3BRW = 6;                    // baud rate 9600
    UCA3MCTLW |= 0x11 &lt;&lt; 8 | UCBRF_8 | UCOS16;
    P2SEL0 &amp;= ~BIT0;                // port function
    P2SEL1 |= BIT0;
    UCA3CTLW0 &amp;= ~UCSWRST;

    // P1.6 UCB0SDA, P1.7 UCB0SCL
    UCB0CTLW0 |= UCSWRST;
    UCB0CTLW0 |= UCSSEL_3;          // clock source SMCLK
    UCB0BRW = 16;                   // I2C clock, SMCLK/16 = 62.5kHz
    UCB0CTLW0 |= UCMODE_3;          // port mode I2C
    UCB0CTLW0 |= UCMST;             // I2C mode master
    UCB0I2CSA = 0x48;               // LM75A I2C address
    UCB0CTLW1 |= UCASTP_2;          // I2C auto stop when read byte count reaches UCB0TBCNT
    UCB0TBCNT = 1;                  // I2C read count
    P1SEL1 |= BIT6;                 // port function
    P1SEL0 &amp;= ~BIT6;
    P1SEL1 |= BIT7;
    P1SEL0 &amp;= ~BIT7;
    UCB0CTLW0 &amp;= ~UCSWRST;

    for (;;) {
        /*
         * Read temperature sensor
         * LM75A temperature sensor on I2C bus
         */

        __delay_cycles(1000000);
        UCB0CTLW0 |= UCTXSTT; // Start bit
        __delay_cycles(5000);

        // read I2C RX buffer
        temperature = UCB0RXBUF;

#if 1
        uart_buf_n = sprintf(uart_buf, &quot;lm75 %d Celsius\r\n&quot;, temperature);
        for (i = 0; i &lt; uart_buf_n; i++) {
            UCA3TXBUF = uart_buf[i];
            __delay_cycles(200000);
        }
#endif
        /*
         * Bluetooth beacon
         * Transmit temperature over Bluetooth
         * Microchip RN4871 Bluetooth module over UART
         *
         * BTHome Bluetooth Data Protocol
         * https://bthome.io/
         *
         * It should be read reply for each RN4871 command, but as we don't
         * lets wait a little bit and hope all is ok.
         */

        temperature = 100 * temperature;

        // Open command mode
        i = 0;
        uart_buf[i++] = '$';
        uart_buf[i++] = '$';
        uart_buf[i++] = '$';
        uart_buf[i++] = '\r';
        uart_buf[i++] = '\n';

        uart_buf_n = i;

        for (i = 0; i &lt; uart_buf_n; i++) {
            UCA3TXBUF = uart_buf[i];
            __delay_cycles(200000);
        }
        __delay_cycles(1000000);

        // Clear advertisement
        i = 0;
        uart_buf[i++] = 'I';
        uart_buf[i++] = 'A';
        uart_buf[i++] = ',';
        uart_buf[i++] = 'Z';
        uart_buf[i++] = '\r';
        uart_buf[i++] = '\n';

        uart_buf_n = i;

        for (i = 0; i &lt; uart_buf_n; i++) {
            UCA3TXBUF = uart_buf[i];
            __delay_cycles(200000);
        }
        __delay_cycles(1000000);


        // Set advertisement, BTHome API payload
        i = 0;
        uart_buf[i++] = 'I';
        uart_buf[i++] = 'A';
        uart_buf[i++] = ',';
        uart_buf[i++] = '1';
        uart_buf[i++] = '6';
        uart_buf[i++] = ',';
        uart_buf[i++] = '1';
        uart_buf[i++] = 'C';
        uart_buf[i++] = '1';
        uart_buf[i++] = '8';
        uart_buf[i++] = '2';
        uart_buf[i++] = '3';
        uart_buf[i++] = '0';
        uart_buf[i++] = '2';
        sprintf(&amp;uart_buf[i++], &quot;%x&quot;, ((temperature &gt;&gt;  4) &amp; 0xf));
        sprintf(&amp;uart_buf[i++], &quot;%x&quot;, ((temperature &gt;&gt;  0) &amp; 0xf));
        sprintf(&amp;uart_buf[i++], &quot;%x&quot;, ((temperature &gt;&gt; 12) &amp; 0xf));
        sprintf(&amp;uart_buf[i++], &quot;%x&quot;, ((temperature &gt;&gt;  8) &amp; 0xf));
        uart_buf[i++] = '\r';
        uart_buf[i++] = '\n';

        uart_buf_n = i;

        for (i = 0; i &lt; uart_buf_n; i++) {
            UCA3TXBUF = uart_buf[i];
            __delay_cycles(200000);
        }
        __delay_cycles(1000000);

        // Close command mode
        i = 0;
        uart_buf[i++] = '-';
        uart_buf[i++] = '-';
        uart_buf[i++] = '-';
        uart_buf[i++] = '\r';
        uart_buf[i++] = '\n';

        uart_buf_n = i;

        for (i = 0; i &lt; uart_buf_n; i++) {
            UCA3TXBUF = uart_buf[i];
            __delay_cycles(200000);
        }
        __delay_cycles(1000000);
    }
}
</code></pre>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/test_setup.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Test wiring</td>
</tr>
</tbody>
</table>
<h2 id="home-assistant-bluetooth-integration">Home Assistant Bluetooth integration</h2>
<p>Home Assistant home automation recently got native <a href="https://www.home-assistant.io/integrations/bluetooth/">Bluetooth integration</a>. The automation recognizes the sensor automatically and gets it into the system with a couple of mouse clicks.</p>
<p><a href="https://bthome.io/">BTHome</a> is an open standard for broadcasting sensor data over Bluetooth LE. </p>
<p>RN_BLE is the default Bluetooth name configured in the Microchip Technology RN4871 module. It can be changed easily. </p>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/hass_setup1.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Home Assistant setup</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/hass_setup2.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Home Assistant setup</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/hass_setup3.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Home Assistant sensors in workroom</td>
</tr>
</tbody>
</table>
<p>The pictures show how the sensor resolution affects the data. The RN_BLE sensor uses 1C degree resolution and the ATC (Xiaomi) sensor uses 0.01C degree resolution. The Xiaomi sensor is here only as an example for comparison - it gives an idea of how the sensor should work when configured for a better resolution.</p>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/hass_windy_temp.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Home Assistant sensor data for the day</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/hass_xiaomi_temp.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Home Assistant sensor data for the day - Xiaomi sensor</td>
</tr>
</tbody>
</table>
<h2 id="case-design">Case design</h2>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/case.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Case</td>
</tr>
</tbody>
</table>
<h3 id="making-the-device-case">Making the device case</h3>
<p>My intention is to make a weather station with an ultrasonic anemometer. I designed the case to be suitable for ultrasonic wind measurement so that I can use it to test the wind measurement later. For measuring temperature and humidity, the housing should have some kind of breathable structure that prevents direct sunlight from reaching the sensor in order to improve the quality of the measurement results. This structure is called a sunlight radiation shield.</p>
<h3 id="radiation-shield-section">Radiation shield section</h3>
<p>The radiation shields used in weather stations usually always look roughly the same - a few disk-shaped plates are piled on top of each other so that the air flow gets to the sensor from between the plates. Radiation shields can be purchased separately, but if you want to integrate the entire weather station up to the anemometer, it may make sense to design and manufacture the entire housing yourself. I did not implement radiation protection at this stage.</p>
<h3 id="wind-tunnel-section">Wind tunnel section</h3>
<p>Two different constructions are usually used in ultrasonic anemometers. In a simpler model, the ultrasonic sensors are placed against each other and the sound travels directly from one sensor to another. In the second method, the ultrasound signal is reflected from one sensor to another through the surface. Local weather conditions, winter, snow, freezing, the latter structure would seem smarter because by placing the sensors on the ceiling and reflecting the signal from the floor, the sensors would be protected from the weather. I have bought 4 pcs of 200kHz ultrasound transducers, so I made places for them in the case for further development.</p>
<h3 id="microcontroller-housing-section">Microcontroller housing section</h3>
<p>The design of the microcontroller housing is quite free. The only requirements are that the electronics must be protected from the weather and that the housing does not unnecessarily affect the operation of the weather sensors. In this case, I placed the electronics above the wind tunnel because it is easiest to connect the wires to the ultrasonic sensors. The current housing probably interferes with the wind measurement unnecessarily and it needs to be improved later.</p>
<h3 id="modeling-of-the-device-housing">Modeling of the device housing</h3>
<p>I modeled the device case with FreeCAD. I made the holes for the ultrasonic transducers at an angle where the reflection takes place as directly as possible. Modeling the holes was the most difficult operation because the holes were not parallel to the coordinate axes of the model. I used the Datum Plane tool for each hole to define a suitable sloping surface. Maybe there is a smarter way to do this...</p>
<h3 id="making-the-case">Making the case</h3>
<p>The case is 3D printed in 2 parts - body and cover. I generated the toolpaths with Cura and printed with an Ender 3 S1 3D printer. I used tree support and the worst quality setting 0.28mm. Still, the printing time was so long that I had to stop and resume printing several times. The interruptions always left a small visible seam in the product.</p>
<table>
<thead>
<tr>
<th>Part</th>
<th>Print time</th>
<th>Material amount</th>
</tr>
</thead>
<tbody>
<tr>
<td>Body</td>
<td>13h06min</td>
<td>129g</td>
</tr>
<tr>
<td>Cap</td>
<td>2h26min</td>
<td>28g</td>
</tr>
</tbody>
</table>
<p>The material was white PLA. Waterproof should be better taken into account in the device case for outdoor use. The case printed with PLA is probably too porous.</p>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/case_body.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Case, body</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/case_cap.png" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Case, cap</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/case_body.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>3D printing</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/case_cap.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>3D printing</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/case.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/meter1.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/meter2.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h3 id="making-a-sticker">Making a sticker</h3>
<p>The exercise spec says:</p>
<blockquote>
<p>Your project should incorporate 2D and 3D design, additive and subtractive fabrication processes, electronics design and production, embedded microcontroller interfacing and programming, system integration and packaging.</p>
</blockquote>
<p>In my opinion, PCB milling is "subtractive fabrication processes". However, the instructor of the course, Jani Ylioja, was of the opinion that manufacturing the circuit board by milling does not meet that requirement. So, to fulfill the requirements, I made a sticker with FabLab's computer-controlled vinyl cutter.</p>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/Wiima_sticker_1.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Roland CAMM-1 GS-24 vinyl cutter</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/Wiima_sticker_2.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Stickers</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><img alt="" src="../images/finalproject/Wiima.resized.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td>Enjoy!</td>
</tr>
</tbody>
</table>
<h2 id="bill-of-material">Bill of material</h2>
<p>All the materials cost about 57e, excluding development tools.</p>
<p>As a special device, you also need a programming device for the microcontroller. There are several different types of programming devices. For that I bought <a href="https://www.ti.com/tool/EVM430-FR6043">Texas Instruments EVM430-FR6043</a> which cost ~230e. </p>
<ul>
<li><a href="https://www.ti.com/tool/EVM430-FR6043">Texas Instruments EVM430-FR6043</a></li>
</ul>
<h3 id="main-pcb">Main PCB</h3>
<p>The materials cost about 24.25. </p>
<table>
<thead>
<tr>
<th>Qty</th>
<th>Reference(s)</th>
<th>Value</th>
<th>LibPart</th>
<th>Price </th>
<th>Supplier</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>C1, C2, C3, C4</td>
<td>18pF</td>
<td>Device:C_Small</td>
<td>0.04</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>3</td>
<td>C5, C7, C9</td>
<td>1u</td>
<td>pspice:C</td>
<td>0.03</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>3</td>
<td>C6, C8, C10</td>
<td>100n</td>
<td>pspice:C</td>
<td>0.03</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>2</td>
<td>C11, C13</td>
<td>22u</td>
<td>pspice:C</td>
<td>0.02</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>2</td>
<td>C12, C14</td>
<td>1n</td>
<td>pspice:C</td>
<td>0.02</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>1</td>
<td>C15</td>
<td>2.2nF</td>
<td>Device:C_Small</td>
<td>0.01</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>1</td>
<td>J1</td>
<td>Conn_01x02_Male</td>
<td>Connector:Conn_01x02_Male</td>
<td>0.10</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>1</td>
<td>J2</td>
<td>Conn_01x16_Male</td>
<td>Connector:Conn_01x16_Male</td>
<td>0.20</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>1</td>
<td>J3</td>
<td>Conn_02x10_Odd_Even</td>
<td>Connector_Generic:Conn_02x10_Odd_Even</td>
<td>0.60</td>
<td>SP-Elektroniikka</td>
</tr>
<tr>
<td>6</td>
<td>J4, J5, J6, J7, J8, J9</td>
<td>Conn_01x06_Male</td>
<td>Connector:Conn_01x06_Male</td>
<td>0.60</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>3</td>
<td>R1, R2, RJ1</td>
<td>0R</td>
<td>Device:R_Small</td>
<td>0.03</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>2</td>
<td>R3, R4</td>
<td>22</td>
<td>Device:R</td>
<td>0.02</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>1</td>
<td>R5</td>
<td>47k</td>
<td>Device:R_Small</td>
<td>0.01</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>4</td>
<td>R6, R7, R8, R9</td>
<td>10k</td>
<td>Device:R_Small</td>
<td>0.04</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>1</td>
<td>SW1</td>
<td>SW_Push</td>
<td>Switch:SW_Push</td>
<td>0.50</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>1</td>
<td>U1</td>
<td>MSP430FR6043IPN</td>
<td>wiima:MSP430FR6043IPN</td>
<td>18.00</td>
<td>Mouser</td>
</tr>
<tr>
<td>1</td>
<td>Y1</td>
<td>32.768kHz</td>
<td>Device:Crystal</td>
<td>1.50</td>
<td>SP-Elektroniikka</td>
</tr>
<tr>
<td>1</td>
<td>Y2</td>
<td>8MHz</td>
<td>Device:Crystal</td>
<td>1.50</td>
<td>SP-Elektroniikka</td>
</tr>
<tr>
<td>1</td>
<td></td>
<td></td>
<td>PCB single sided 10x10cm</td>
<td>1.00</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td>24.25</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="bluetooth-radio_1">Bluetooth radio</h3>
<p>The materials cost about 11.22. </p>
<table>
<thead>
<tr>
<th>Qty</th>
<th>Reference(s)</th>
<th>Value</th>
<th>LibPart</th>
<th>Price </th>
<th>Supplier</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>C1</td>
<td>10uF</td>
<td>Device:C_Small</td>
<td>0.01</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>1</td>
<td>D1</td>
<td>LED</td>
<td>Device:LED</td>
<td>0.10</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>1</td>
<td>J1</td>
<td>Conn_01x04_Male</td>
<td>Connector:Conn_01x04_Male</td>
<td>0.10</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>1</td>
<td>R1</td>
<td>0R</td>
<td>Device:R_Small</td>
<td>0.01</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>1</td>
<td>R2</td>
<td>330R</td>
<td>Device:R_Small</td>
<td>0.01</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>1</td>
<td>U1</td>
<td>RN4871</td>
<td>RF_Bluetooth:RN4871</td>
<td>10.00</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td>1</td>
<td></td>
<td></td>
<td>PCB single sided 3x3cm</td>
<td>1.00</td>
<td>Fab Lab inventory</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td>11.22</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="temperature-sensor_1">Temperature sensor</h3>
<p>The materials cost about 2.54. </p>
<table>
<thead>
<tr>
<th>Qty</th>
<th>Reference(s)</th>
<th>Value</th>
<th>LibPart</th>
<th>Price </th>
<th>Supplier</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td></td>
<td>CJMCU-75</td>
<td></td>
<td>2.52</td>
<td>AliExpress</td>
</tr>
<tr>
<td>2</td>
<td>R0, R1</td>
<td>10k</td>
<td>Device:R_Small</td>
<td>0.02</td>
<td>Antti inventory</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td>2.54</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="case">Case</h3>
<p>The materials cost about 5.00. </p>
<table>
<thead>
<tr>
<th>Qty</th>
<th>Reference(s)</th>
<th>Value</th>
<th>LibPart</th>
<th>Price </th>
<th>Supplier</th>
</tr>
</thead>
<tbody>
<tr>
<td>200g</td>
<td></td>
<td></td>
<td>PLA filament</td>
<td>5.00</td>
<td>Antti inventory</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td>5.00</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="licenses">Licenses</h2>
<p>License for design CC0.</p>
<p>License for software MIT.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.ti.com/product/MSP430FR6043">Texas Instruments MSP430FR6043</a></li>
<li><a href="https://www.ti.com/tool/EVM430-FR6043">Texas Instruments EVM430-FR6043</a></li>
<li><a href="https://www.nxp.com/part/LM75AD#/">NXP LM75AD</a></li>
<li><a href="https://www.bosch-sensortec.com/products/environmental-sensors/humidity-sensors-bme280/">Bosch Sensortec BME280</a></li>
<li><a href="https://www.ti.com/tool/CCSTUDIO">Texas Instruments CCSTUDIO</a></li>
<li><a href="https://www.microchip.com/en-us/product/RN4871#">Microchip Technology RN4871</a></li>
<li><a href="https://bthome.io/">BTHome</a></li>
<li><a href="https://play.google.com/store/apps/details?id=com.macdom.ble.blescanner">BLE Scanner (Connect &amp; Notify)</a></li>
</ul>
<h2 id="files">Files</h2>
<ul>
<li>PCB<ul>
<li><a href="../images/finalproject/anemometer.zip">anemometer.zip</a></li>
<li><a href="../images/finalproject/RN4871_bluetooth.zip">RN4871_bluetooth.zip</a></li>
</ul>
</li>
<li>Code<ul>
<li><a href="../images/finalproject/main.c">main.c</a></li>
</ul>
</li>
<li>Case<ul>
<li><a href="../images/finalproject/FabWindy.FCStd">FabWindy.FCStd</a></li>
<li><a href="../images/finalproject/FabWindy-Body.stl">FabWindy-Body.stl</a></li>
<li><a href="../images/finalproject/FabWindy-Cap.stl">FabWindy-Cap.stl</a></li>
<li><a href="../images/finalproject/Wiima_sticker.svg">Wiima_sticker.svg</a></li>
</ul>
</li>
</ul>
<h2 id="final-thoughts">Final thoughts</h2>
<p>It was supposed to be a weather station with an anemometer, but now it only measures temperature. </p>
<p>Right from the beginning of the course, it was clear that building an ultrasonic anemometer is too big a job for this exercise. After the discussions at the beginning of the course, the features of the device were reduced with a heavy hand, keeping in mind that the device can later be added with features suitable for wind measurement as a spiral development. In practice, this was implemented using an MCU suitable for wind measurement. </p>
<p>The lab didn't have MSP430 family MCUs at all, so I couldn't use them in the previous exercises, instead I used an ESP32 MCU. This increased the workload radically because I couldn't really use anything from the previous exercises. The MSP430 was a completely new platform for me. </p>
<p>I will continue developing the section suitable for ultrasonic wind measurement after the course. The PCB has connections suitable for ultrasonic wind measurement, for which I will first try to build an additional board. Finally, a completely new version of the device will be made with better integration. </p>




              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href=".." class="md-footer__link md-footer__link--prev" aria-label="Previous: About Me" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              About Me
            </div>
          </div>
        </a>
      
      
        
        <a href="../assignments/week01/" class="md-footer__link md-footer__link--next" aria-label="Next: 1. Principles and practices" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              1. Principles and practices
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.9c69f0bc.min.js"></script>
      
    
  </body>
</html>